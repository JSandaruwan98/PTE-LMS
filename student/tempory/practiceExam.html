<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,400,300,500,600,700" rel="stylesheet"> 
    <link rel="stylesheet" href="css/practiceExam.css">

    <script>
       
        $('#discussion').click(function(){
            $.ajax({
                url: 'discussion.html',
                type: 'GET',
                dataType: 'html',
                success: function(response) {
                    $('#sub-discussion').html(response);
                },
                error: function(error) {
                    console.error('Error fetching HTML:', error);
                }
            });
        });
       
      </script>

</head>
<body>
    <!--Section 01 (this section Displayed Question Type)-->
    <section>
        <h1 id="type_name" class="ms-5 pb-4 " style="top: -60px; font-weight: normal; font-size: 25px"></h1>
    </section>
    <!--Section 02 (this section Displayed main banner image)-->
    <section class="banner-area relative about-banner" id="home">	
        <div class="overlay overlay-bg" style="background-color: rgba(0, 65, 65, 0.5);"></div>
        <div class="container">				
            <div class="row d-flex align-items-center justify-content-center">
                <div class="about-content col-lg-12">
                    student/images/Rectangle 114.png
                </div>	
            </div>
        </div>
    </section>
    <!--Section 03 (This section is used for recording and submiting answers)-->
    <section class="feature-area" id="block">
        <div class="container">
            <div class="row" >
                <div class="col-md-12" >
                    <div class="feature-area" id="feature-area">
                        <div class="single-feature" id="single-feature">
                            <div class="title" id="title" style="height: 70px; text-align: justify; padding: 15px;"></div>
                            <div class="desc-wrap" style="background-color: rgb(218, 253, 253); ">
                               
                                <!--************************************************************************************************************-->
                                <!--timer row-->
                                <div class="row">
                                    <div class="col-2">
                                        <div style="color: red;">Prepair Time</div>
                                        <div id="prepair-timer" style="color: red;">00:00:00</div>
                                    </div>
                                    <div class="col-7">
                                        <div class="progress">
                                            <div id="myProgressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                    <div class="col-2 ms-5">
                                        <div data-role="controls">
                                            <div id="timer">00:00:00</div>
                                        </div>
                                        <div data-role="recordings"></div>
                                    </div>
                                </div>  

                                <!--************************************************************************************************************-->
                                <!--question and recording row-->
                                <div class="row">
                                    <div class="col-2"></div>
                                    <div class="col-7">
                                        <div id="solution" style="text-align: justify; color: #222; margin-top: 25px; padding-left: 30px; padding-right: 30px;"></div>
                                    </div>
                                    <div class="col-2 ms-5" style="text-align: cente;">
                                        <div data-role="controls">
                                            <button id="recordButton" style="height: 50px; width: 50px; padding-left: 50px;">Record</button>
                                            <a  href="#" id="submit" style="font-size: 20px; font-weight:400;">Submit</a>
                                            <div class="spinner-border text-primary" role="status" style="display:inline-block;">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                        </div>
                                        <div data-role="recordings"></div>
                                    </div>
                                </div>

                                <!--************************************************************************************************************-->
                                <!--button row-->      
                                <div class="row" style="margin-top: 60px;">
                                    <div class="col-2">
                                        <a  href="#" id="previous" style="font-size: 20px; font-weight:600; float: left;">Previuos</a>
                                    </div>
                                    <div class="col-8">
                                        <a style="font-size: 20px; font-weight:600;"><span id="currentPage">1</span> /<span id="totalPages">1</span></a>
                                    </div>
                                    <div class="col-2">
                                        <a  href="#" id="next" style="font-size: 20px; font-weight:600; float: right;">Next</a>	
                                    </div>
                                </div>

                                <!--************************************************************************************************************-->    

                            </div>    
                            </div>
                        </div>
                    </div>
                </div>
         	 </div>
        </div>	
    </section>

    <!--Section 04-->
    <section style="margin-left: 90px; margin-top: 30px;">
        <audio controls style="width: 300px; height: 60px;">
            <source src="${data['data'][i].audio}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </section>

    <!--Section 05-->
    <section style="margin-left: 80px; margin-top: 30px;">
       <h5 style=" font-weight:300">AI Scoring and Audio Answer Download is available after submission.</h5>
    </section>

    <!--Section 06-->
    <section style="margin-left: 80px; margin-top: 30px;">
        <button type="button" class="btn btn-outline-primary" style="width: 100px; height: 35px; font-size: 15px;">Re-do</button>
        <button type="button" class="btn btn-primary ms-4 text-white" style="width: 120px; height: 35px; font-size: 15px;">Translation</button>
    </section>

    <!--Section 07-->
    <section style="margin-left: 80px; margin-top: 30px;">
        <h3 class="ms-5" style="font-size:medium;">Discussion</h3>
    </section>

    <!--Section 08-->
    <section style="margin: 60px; margin-top: 30px;">
        <div type="button" class="tab btn btn-outline-primary" data-tab="tab1" style="width: 100px; height: 35px; font-size: 15px;">Discussion</div>
        <div type="button" class="tab btn btn-outline-primary" data-tab="tab2" style="width: 100px; height: 35px; font-size: 15px;">Board</div>
        <div type="button" class="tab btn btn-outline-primary" data-tab="tab3" style="width: 100px; height: 35px; font-size: 15px;">Me</div>
        
        <!--*****************************************************************************************************************************************************-->
        
        <div class="tab-content" id="tab1">
            <p>Content for Tab 3 goes here.</p>
        </div>

        <!--*****************************************************************************************************************************************************-->
        
        <div class="tab-content" id="tab2">
            <div class="row d-flex mb-4">
                <div class="col-md-7 col-xl-5">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-start align-items-center">
                                <img class="rounded-circle shadow-1-strong me-3"
                                src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img%20(19).webp" alt="avatar" width="60"
                                height="60" />
                                <div>
                                    <h6 class="fw-bold text-primary">Lily Coleman</h6>
                                    <audio controls style="width: 330px; height: 40px;">
                                        <source src="${data['data'][i].audio}" type="audio/mpeg">
                                        Your browser does not support the audio element.
                                    </audio><br>
                                    <div class="btn btn-outline-primary fw-bold rounded"  style="font-size: 10px;">Score Info</div>
                                </div>
                            </div>   
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--*****************************************************************************************************************************************************-->
        
        <div class="tab-content" id="tab3">
            
        </div>

        <!--*****************************************************************************************************************************************************-->

        <div class="b1">
            <div class="overlay-content-popup" id="overlay-content-popup">
                <div id="cb" class="content-popup">
                    <div class="container">
                        <div class="row">
                            <div style="text-align: left; font-weight: 300;">Score Info</div>
                        </div>
                        
                        <div class="row mx-3">
                            <div class="col-5 py-3">
                                <!--using progress bar display for the total score-->
                                <div class="row px-2">
                                    <div class="p-2">
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: 25%" aria-valuenow="4" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div style="font-weight: 300;">Total</div>
                                    </div>     
                                </div>

                                <!--content, pronounciation and fluency score-->
                                <div class="row px-2">
                                    <div class="col-4 p-1">
                                        <div class="p-2"  style="background-color: white; box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                            <span>Content</span><br><span style="color: green;"><span id="content-marks"></span>/5</span>
                                        </div>
                                    </div>
                                    <div class="col-4 p-1">
                                        <div  class="p-2" style="background-color: white; box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                            <span>Pronoun</span><br><span style="color: rgb(255, 162, 0);"><span id="pronoun-marks"></span>/5</span>
                                        </div>
                                    </div>
                                    <div class="col-4 p-1">
                                        <div class="p-2"  style="background-color: white; box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                            <span>Fluency</span><br><span style="color: purple;"><span id="fluency-marks"></span>/5</span>
                                        </div>
                                    </div>
                                </div>


                                <div class="row px-2">
                                    <div class="p-2"></div><h4 class="h6" style="text-align: left;">Skill Analysis</h4>
                                    <p class="lh-sm" style="font-weight: 500; font-size: 10px; text-align:justify">The following scores show how you have performed in different aspects as compared to other users. These scores can be used to analyse how you can improve in this question, but they are not directly related to the PTE scores.</p>
                                </div>

                                <!--Each presentation is described using a progress bar of pronunciation, fluency, stress and speed-->
                                <div class="row">
                                    <div class="p-2"  style="background-color: white; box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <div>
                                            <div class="progress mt-1">
                                                <div id="pronoun-progress" class="progress-bar" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            <h4 class="h6" style="font-size: 10px; text-align: right;"><span style="float: left;">Pronounciation Accuracy</span> <span id="pronoun-precentage"  class="text-primary"></span></h4>
                                        </div>
                                        <div>
                                            <div class="progress mt-1">
                                                <div id="fluent-progress" class="progress-bar" role="progressbar" aria-valuenow="4" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            <h4 class="h6" style="font-size: 10px; text-align: right;"><span style="float: left;">Fluent</span> <span id="fluent-precentage" class="text-primary"></span></h4>
                                        </div>
                                        <div>
                                            <div class="progress mt-1">
                                                <div id="stress-progress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            <h4 class="h6" style="font-size: 10px; text-align: right;"><span style="float: left;">Stress</span> <span class="text-primary">0%</span></h4>
                                        </div>
                                        <div>
                                            <div class="progress mt-1">
                                                <div id="speed-progress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            <h4 class="h6" style="font-size: 10px; text-align: right;"><span style="float: left;">Speed</span> <span class="text-primary">0%</span></h4>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="col-7 ps-5">
                                <!--student answer audio-->
                                <div class="row">
                                    <div class="py-4" style="background-color: white; box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <audio id="user-answer-recording" controls style="width: 300px;">
                                        </audio>
                                    </div>
                                </div>

                                <!--Missed words of given question-->
                                <div class="row px-2">
                                    <div class="p-2"></div><h4 class="h6" style="text-align: left;">Content</h4>
                                    <p style="font-weight: 300; font-size: 14px; text-align:justify">
                                        <span>Missed words<span style="margin-left: 15px; height: 13px; width: 13px; background-color: #b80707; border-radius: 50%; display: inline-block;"></span></span>
                                        <span style="margin-left: 40px;">Aditional words<span style="margin-left: 15px; height: 13px; width: 13px; background-color: #b80707; border-radius: 50%; display: inline-block;"></span>
                                    </p>
                                </div>
                                <div class="row">
                                    <div class="p-2"  style="background-color: white; box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.3); border-radius: 5px;">
                                        <p id="question-solution"  style="font-weight: 500; font-size: 15px; text-align:justify"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> 
                </div>
            </div>
        </div>

    </section>
    <section id="sub-discussion" style="margin-left: 80px; margin-top: 30px;">
        <h1></h1>
    </section>


    <script src="js/ajaxManager.js"></script>
    <script src="js/practiceExamBoard/tabClick.js"></script>
    <script src="js/practiceExamBoard/fetchAndDisplay.js"></script>
    <script src="js/practiceExamBoard/timer.js"></script>
    <script src="js/practiceExamBoard/recording.js"></script>

    <script>

        $(document).ready(function () {

            var fragment = window.location.hash;
            if (fragment.includes('type')) { var typeValue = parseInt(fragment.split('=')[1]); } 
            else { console.log('Type parameter not found in the URL.'); }

            console.log(typeValue)

            //banner image and type assign
            if(typeValue == 1){
                type = 'Read Aloud';
                image = 'images/img/78c8b120464e6b53b3877ad0de114ad3.jpg';
            }else if(typeValue == 2){
                type = 'Repeat Sentence';
                image = 'images/img/cta-bg.jpg';
            }else if(typeValue == 3){
                type = 'Describe image';
                image = 'images/img/top-banner.jpg';
            }else if(typeValue == 4){
                type = 'Re-tell Lecture';
                image = 'images/img/R.jpg';    
            }else if(typeValue == 5){
                type = 'Answer Short Question';
                image = 'images/img/slider3.png';        
            }

            //display type name and banner image
            $('#type_name').text(type);
            $('#home').css({'background': 'url('+image+') right'})

            //DOMElement call
            const toggleRecordingButton = $('#recordButton');
            const progressBar = document.getElementById('myProgressBar');
            const audioPlayer = $('#audioPlayer');

            //objects create
            const ajaxManager = new AJAXManager();
            const fetchAndDisplayManager = new FetchAndDisplayManager(ajaxManager);
            const timer1 = new TimeManager(1, toggleRecordingButton, progressBar);
            const timer2 = new TimeManager(2, toggleRecordingButton, progressBar);
            const recording =new Recording(audioPlayer);

            //page assign
            var currentPage = 1;
            var questionsPerPage = 1;
            let isRecording = false;
            let audioChunks = [];
            let KeyWords;
            let audioFile;
            let Solution;

            //type number assign
           

            function fetchAndDisplayQuestions(page){
                
                ajaxManager.fetchData(`data_type=questionDisplay&page=${page}&per_page=${questionsPerPage}&test_id=${11}&type=${type}`, 
                function (data) {
                    timer2.resetTimer()
                    isRecording = false;
                    timer2.startTimer()
                    $('#title').empty();
                    $('#Question').empty();
                    $('#solution').empty();
                    totalPages = data['totalItems'].Count;
                    for (var i = 0; i < data['data'].length; i++) {
                        Solution = data['data'][i].solution;
                        type = data['data'][i].type;
                        KeyWords = data['data'][i].key_words
                        question_id = data['data'][i].question_id;

                        $('#title').append(`<h2 style="color: white;">${data['data'][i].question}</h2>`);
                        if(type == "Read Aloud"){
                            $('#solution').append(`<p>${data['data'][i].solution}</p>`);
                        }else if(type == "Describe image"){
                            try{
                                $('#solution').append(`<img src="${data['data'][i].imageFile}" style="width:450px; padding-left: 25%; height: 250px">`);
                            }catch(error){
                                console.log(error.message)
                            }
                        }else if(type == "Repeat Sentence" || type == "Re-tell Lecture" || type == "Answer Short Question"){
                            $('#solution').append(`
                                <audio controls style="padding-left: 25%">
                                    <source src="${data['data'][i].audio}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>`);
                        }
                    }
                    
                    function updatePagination() {
                        $("#currentPage").text(currentPage);
                        $("#totalPages").text(totalPages);
                        
                    }

                    updatePagination()
                    fetchAndDisplayManager.discussion(question_id)
                }, 
                function (error) {
                    console.error('Error fetching data:', error);
                })
            }

            fetchAndDisplayQuestions(currentPage)

            // Event listener for Previous button
            $("#previous").on("click", function() {
                if (currentPage > 1) {
                    currentPage--;
                    fetchAndDisplayQuestions(currentPage);
                    timer1.resetTimer();
                    timer2.resetTimer();
                }
            });
        
            // Event listener for Next button
            $("#next").on("click", function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    fetchAndDisplayQuestions(currentPage);
                    timer1.resetTimer();
                    timer2.resetTimer();
                }
            });

        /***********************************************************************************************************************************************************/

            toggleRecordingButton.on('click', function () {
                if (!isRecording) {
                    timer2.stopTimer()
                    timer1.resetTimer()
                    timer1.startTimer()
                    recording.startRecording();
                    console.log("start")
                    toggleRecordingButton.text('Stop Recording');
                } else {
                    timer1.stopTimer()
                    let audioFile = recording.stopRecording();
                    console.log("stop")
                    toggleRecordingButton.text('Start Recording');
                }
                isRecording = !isRecording;
            });

        
        /***********************************************************************************************************************************************************/           


            $('#submit').on('click', function(){
                console.log(type);
                console.log(KeyWords);
                if(type == 'Read Aloud' || type == 'Repeat Sentence'){
                    task = 'normal_comparison'
                }else if(type == 'Describe image' || type == 'Repeat Sentence' || type == 'Answer Short Question'){
                    task = 'ai_analysis'
                }

                $.ajax({
                    url:'src/controllers/postController.php',
                    type: 'POST',
                    data: { task : task, audioFile: recording.getResult(), Solution: Solution, question_id: question_id, student_id: 2, key_words: KeyWords, type: type},
                    success: function(response){
                        console.log(response)
                        if(response.success){
                            console.log(response.message);
                            fetchAndDisplayManager.discussion(question_id)
                        }else{
                            console.log(response.message);
                            
                        }
                    },
                    error: function (error) {
                        console.log(response.message);
                        console.log(response.comment);
                        console.error('Error saving audio:', error); 
                    }
                })
            });
            
        })

    </script>


</body>
</html>